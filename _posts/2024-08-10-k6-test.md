---
title: "[K6] K6 Test"
date: 2024-08-10
categories: [K6, Test]
tags: [K6, Test, JavaScript]
---

# K6 Test
## Lifecycle

- k6의 Lifecycle은 크게 네가지
```
// 1. 초기화
// 2. 전처리
export function setup() {
  //　로그인 토큰취득 등 API실행전에 필요한 처리 구현
}
// 3. API실행(시나리오 실행)
export default function (data) {
  // API를 실행할 시나리오를 구현
}
// 4. API 실행후 처리
export function teardown(data) {
  // API 실행후에 필요한 처리가 있다면 구현
}
```

## Test Code 작성 방법

```
import http from "k6/http" // http test

import { sleep } from "k6" // sleep 기능 사용 시 추가 (sleep(n) -> 지정한 n 기간 동한 VU 실행을 일시 중지)

export let options = {

	vus: 10,          // 가상의 유저 수

	duration: '1m'   // 테스트 진행 시간

};

const BASE_URL = '테스트 URL';

export default function () {

	let getUrl = BASE_URL

	http.get(getUrl);

	sleep(1);

}
```

```
import http from "k6/http";
import { sleep, check } from "k6";
import { Trend } from "k6/metrics";

const trends = {
  scenario1: new Trend("scenario1) Response time", true),
  scenario2: new Trend("scenario2) Response time", true),
};

const VUS = 1;
const DURATION = "10s";

export const options = {
  scenarios: {
    scenario1: {
      executor: "constant-vus",
      exec: "scenarioFunc",
      vus: VUS,
      duration: DURATION,
      env: {
        SCENARIO_ID: "1",
      },
    },
    scenario2: {
      executor: "constant-vus",
      exec: "scenarioFunc",
      vus: VUS,
      duration: DURATION,
      env: {
        SCENARIO_ID: "2",
      },
    },
  },
};

export function setup() {
  const url = ""; // token취득
  const params = {
    headers: {
      Authorization: "Bearer XXX",
    },
  };
  const res = http.get(url, params);
  const token = JSON.parse(res.body).account.token;

  return token;
}

export function scenarioFunc(token) {
  const scenarioUrl = ""; // 실행할 API
  const scenario = http.get(scenarioUrl, {
    headers: {
      Authorization: `Bearer ${token}`,
    },
  });
  __ENV.SCENARIO_ID === "1"
    ? trends.scenario1.add(scenario.timings.duration)
    : trends.scenario2.add(scenario.timings.duration);

  check(scenario, {
    "scenario status is 200": (res) => res.status === 200,
  });

  sleep(1);
}
```

### options 설정 관련
```
export const options = {
  scenarios: {
    scenario1: {
      executor: "constant-vus",
      exec: "scenarioFunc",
      vus: VUS,
      duration: DURATION,
      env: {
        SCENARIO_ID: "1",
      },
    },
  },
};
```

- executor: k6의 실행 엔진을 나타냅니다.

여기에서 VU(Virtual user)나 스크립트 실행 패턴을 지정할 수 있습니다.
자세한 내용은 k6의 executors를 참조해주세요.

- exec: 실행하고자 하는 시나리오를 지정합니다.

- vus: Virtual Users API를 실행할 가상 유저입니다. 필요한 만큼의 병렬 실행수를 여기에 설정합니다.

- duration: VUS가 반복 시나리오를 실행하는 시간을 설정합니다.

- env: 공통으로 사용되는 변수를 설정할 수 있습니다.


[k6 http module](https://k6.io/docs/using-k6/http-requests/#available-methods)
[k6/http 테스트 방법](https://k6.io/docs/javascript-api/#k6-http)

[k6 javascript-api](https://k6.io/docs/javascript-api/)

## [Test 측정 항목](https://k6.io/docs/using-k6/metrics/reference/#standard-built-in-metrics)
| Metric Name | Type | Description |
|:-|:-|:-|
| vus | Gauge | 현재 활성화 된 사용자 유저 |
| vus_max | Gauge | 가능한 최대 가상 사용자 수(로드 레벨을 확장할 때 성능에 영향을 미치지 않도록 VU 리소스가 미리 할당됨) |
| iterations | Counter | 테스트에서 Vu 가 JS 스크립트를 실행한 총 횟수 |
| iteration_duration | Trend | default/main function 의 전체 반복을 한 번 완료하는데 소요된 시간 |
| dropped_iterations | Counter | k6 v0.27.0 에 도입된 VU lack 또는 lack of time 으로 인해 시작할 수 없는 반복 회수 |
| data_received | Counter | 데이터를 전달받은 양 |
| data_sent | Counter | 데이터를 전달한 양 |
| checks | Rate | 성공적으로 체크된 Rate |

## [Http 측정 항목](https://k6.io/docs/using-k6/metrics/reference/#http)
| Metric Name | Type | Description |
|:-|:-|:-|
| http_reqs | Counter | 총 얼마나 많은 HTTP requests 를 k6 에서 생성했는지 횟수 |
| http_req_blocked | Trend | 요청을 시작하기 전에 차단된 시간(TCP connection slot 을 기다리는) 단위: float |
| http_req_connecting | Trend | 원격 호스트에 대한 TCP 연결을 설정하는데 소요된 시간. 단위: float |
| http_req_tls_handshaking | Trend | 원격 호스트와의 핸드셰이킹 TLS 세션에 소요된 시간 |
| http_req_sending | Trend | 원격 호스트에 데이터를 보내는데 소요된 시간. 단위: float |
| http_req_waiting | Trend | 원격 호스트로부터의 응답을 대기하는 데 소요된 시간 (a.k.a. “time to first byte”, or “TTFB”). 단위: float |
| http_req_receiving | Trend | 원격 호스트로부터 응답 데이터를 수신하는 데 소요된 시간. 단위: float |
| http_req_duration | Trend | 요청의 총 시간. It's equal to http_req_sending + http_req_waiting + http_req_receiving (즉, 초기 DNS 조회/연결 시간 없이 원격 서버가 요청을 처리하고 응답하는 데 소요된 시간s). 단위: float |
| http_req_failed | Rate | [setResponseCallback](https://k6.io/docs/javascript-api/k6-http/setresponsecallback/) 에 따른 요칭 실패 비율. |


[Swagger API](https://k6.io/blog/load-testing-your-api-with-swagger-openapi-and-k6/)

[Postman](https://grafana.com/blog/2020/04/19/load-testing-your-api-with-postman/)